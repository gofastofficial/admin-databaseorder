<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Go-Fast • Admin Panel (No Storage • Import/Export)</title>
  <style>
    :root{
      --bg1:#f7fbf8;
      --bg2:#e9f8ef;
      --panel: rgba(255,255,255,.78);
      --card: rgba(255,255,255,.92);
      --line: rgba(16,24,40,.10);
      --text:#0f172a;
      --mut:#475569;
      --acc:#16a34a;
      --acc2:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --good:#10b981;

      --shadow: 0 18px 50px rgba(2,6,23,.08);
      --shadow2: 0 10px 30px rgba(2,6,23,.06);
      --radius: 18px;
      --radius2: 14px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      color:var(--text);
      background:
        radial-gradient(1100px 420px at 12% 8%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 420px at 92% 16%, rgba(16,185,129,.14), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:22px 16px 54px}

    /* Top bar */
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      padding:14px 16px;border:1px solid var(--line);border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65));
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, var(--acc2), var(--acc));
      display:grid;place-items:center;font-weight:900;
      letter-spacing:.5px;
      color:white;
      box-shadow: 0 10px 20px rgba(22,163,74,.18);
    }
    h1{margin:0;font-size:18px}
    .sub{margin:4px 0 0;color:var(--mut);font-size:13px}
    .nav{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    /* Buttons */
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background: rgba(255,255,255,.85);
      color:var(--text); font-weight:800; cursor:pointer;
      transition:.18s transform,.18s box-shadow,.18s background;
      box-shadow: var(--shadow2);
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); background: rgba(255,255,255,.95)}
    .btn.primary{
      border-color: rgba(22,163,74,.22);
      background: linear-gradient(180deg, rgba(34,197,94,.18), rgba(34,197,94,.08));
      box-shadow: 0 14px 28px rgba(22,163,74,.12);
    }
    .btn.danger{
      border-color: rgba(239,68,68,.25);
      background: linear-gradient(180deg, rgba(239,68,68,.10), rgba(239,68,68,.06));
      box-shadow: 0 14px 28px rgba(239,68,68,.10);
    }
    .btn.small{padding:8px 10px; border-radius:10px; font-size:12px; box-shadow:none}

    /* Pills / badges */
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;font-size:12px;font-weight:900;
      border:1px solid var(--line);
      background: rgba(255,255,255,.78);
      color: #0f172a;
      box-shadow: var(--shadow2);
    }
    .pill.ok{border-color:rgba(16,185,129,.22); color:#047857; background: rgba(16,185,129,.10)}
    .pill.warn{border-color:rgba(245,158,11,.22); color:#92400e; background: rgba(245,158,11,.12)}
    .pill.bad{border-color:rgba(239,68,68,.22); color:#991b1b; background: rgba(239,68,68,.10)}
    .pill.soft{border-color:rgba(22,163,74,.18); background: rgba(34,197,94,.06); color:#14532d}

    /* Layout */
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
      border-radius:var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 10px; font-size:14px}
    .mut{color:var(--mut);font-size:13px;line-height:1.45}

    /* Inputs */
    label{display:block;font-size:12px;color:var(--mut);margin:10px 0 6px}
    input,select,textarea{
      width:100%; padding:11px 12px; border-radius:14px;
      border:1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.92);
      color:var(--text); outline:none;
      transition:.15s border, .15s box-shadow;
    }
    textarea{min-height:92px;resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color: rgba(22,163,74,.35);
      box-shadow: 0 0 0 4px rgba(22,163,74,.12);
    }
    input[readonly]{
      background: rgba(255,255,255,.75);
    }

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:680px){.row{grid-template-columns:1fr}}

    .hr{height:1px;background:var(--line);margin:14px 0}

    /* Dashboard KPIs */
    .kpi{
      display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:10px
    }
    @media(max-width:900px){.kpi{grid-template-columns:1fr 1fr}}
    @media(max-width:540px){.kpi{grid-template-columns:1fr}}
    .kpi .box{
      padding:14px; border-radius:16px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.86);
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .kpi .box::after{
      content:"";
      position:absolute; inset:auto -30% -60% -30%;
      height:160px;
      background: radial-gradient(circle at 50% 0%, rgba(34,197,94,.16), transparent 60%);
      pointer-events:none;
    }
    .kpi .box .label{color:var(--mut);font-size:12px; position:relative}
    .kpi .box .val{font-weight:950;margin-top:6px; font-size:18px; position:relative}
    .kpi .box .hint{margin-top:6px; font-size:12px; color:var(--mut); position:relative}

    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .right{text-align:right}

    /* Table */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      overflow:hidden;
      background: rgba(255,255,255,.86);
      box-shadow: var(--shadow2);
    }
    th,td{
      padding:12px;
      border-bottom:1px solid rgba(15,23,42,.08);
      font-size:13px;vertical-align:top
    }
    th{background:rgba(22,163,74,.06);text-align:left;color:#0f172a}
    tr:last-child td{border-bottom:none}

    .linkish{
      color:#0f766e;
      cursor:pointer;
      font-weight:900;
      text-decoration: underline;
      text-decoration-color: rgba(15,118,110,.25);
      text-underline-offset: 3px;
    }

    /* Toast */
    .toast{
      position:fixed; left:16px; bottom:16px;
      padding:12px 14px; border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:none;
      max-width: 520px;
      font-weight:800;
      z-index:9999;
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(2,6,23,.25);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9998;
    }
    .modal{
      width:min(780px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.45);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
      box-shadow: 0 30px 90px rgba(2,6,23,.18);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      border-bottom:1px solid rgba(15,23,42,.08);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(34,197,94,.06));
    }
    .modalHead h3{margin:0; font-size:14px}
    .modalBody{padding:16px}
    .modalFoot{
      padding:14px 16px;
      border-top:1px solid rgba(15,23,42,.08);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      background: rgba(255,255,255,.7);
    }

    .miniGrid{
      display:grid;
      grid-template-columns:1.1fr .9fr;
      gap:12px;
      margin-top:12px;
    }
    @media(max-width:980px){.miniGrid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">GF</div>
        <div>
          <h1>Go-Fast • Admin Panel</h1>
          <div class="sub">No Storage • Input → Export → Import → Rekap Driver → Pembayaran (Import/Export)</div>
        </div>
      </div>
      <div class="nav" id="nav"></div>
    </div>

    <div id="app" style="margin-top:14px"></div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Payment Modal -->
  <div class="backdrop" id="modalBackdrop" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalHead">
        <div>
          <h3 id="modalTitle">Tambah Payment</h3>
          <div class="mut" id="modalSub">—</div>
        </div>
        <button class="btn small" onclick="closeModal()">Tutup</button>
      </div>

      <div class="modalBody">
        <div class="row">
          <div>
            <label>Driver</label>
            <select id="pmDriver"></select>
          </div>
          <div>
            <label>Status</label>
            <select id="pmStatus">
              <option value="pending">PENDING</option>
              <option value="verified">VERIFIED</option>
              <option value="rejected">REJECTED</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Metode</label>
            <select id="pmMethod">
              <option value="BCA">Transfer BCA</option>
              <option value="QRIS">QRIS</option>
            </select>
          </div>
          <div>
            <label>Nominal (Rp)</label>
            <input id="pmAmount" type="number" min="0" placeholder="contoh: 50000" />
          </div>
        </div>

        <label>Catatan / Keterangan (opsional)</label>
        <textarea id="pmNote" placeholder="contoh: bayar 50% dulu, sisanya menyusul"></textarea>

        <div class="hr"></div>

        <div class="kpi" style="margin-top:0">
          <div class="box">
            <div class="label">Total fee (range)</div>
            <div class="val" id="sumFee">Rp0</div>
            <div class="hint">Dihitung dari Orders</div>
          </div>
          <div class="box">
            <div class="label">Min wajib (50%)</div>
            <div class="val" id="sumMin">Rp0</div>
            <div class="hint">Rule operasional</div>
          </div>
          <div class="box">
            <div class="label">Paid (verified)</div>
            <div class="val" id="sumPaid">Rp0</div>
            <div class="hint">Verified saja</div>
          </div>
          <div class="box">
            <div class="label">Sisa belum bayar</div>
            <div class="val" id="sumUnpaid">Rp0</div>
            <div class="hint">Fee - Paid</div>
          </div>
        </div>

        <div class="mut" style="margin-top:10px">
          Info pembayaran: BCA <b class="mono">1210532427</b> a/n <b>Ahmad Rosidi</b> atau QRIS.
        </div>
      </div>

      <div class="modalFoot">
        <button class="btn" onclick="prefillMin50()">Isi Nominal = Minimal Wajib</button>
        <button class="btn primary" onclick="savePaymentFromModal()">Simpan Payment</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG (NO STORAGE)
========================= */
const ADMIN_USER = "admin";
const ADMIN_PASS = "1234";

const ADMIN_FEE_RATE = 0.15; // 15%
const MIN_PAY_RATE   = 0.50; // 50%

/* =========================
   HELPERS
========================= */
const rupiah = n => "Rp" + (Number(n||0)).toLocaleString("id-ID");
const pad2 = n => String(n).padStart(2,"0");
const todayISO = () => {
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
};
const addDaysISO = (iso, days) => {
  const d = new Date(iso + "T00:00:00");
  d.setDate(d.getDate() + days);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
};
const nowStamp = () => {
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
};
const uid = () => (crypto && crypto.randomUUID) ? crypto.randomUUID() : ("id_" + Math.random().toString(16).slice(2));
const dayNameID = (isoDate) => {
  if(!isoDate) return "";
  const d = new Date(isoDate + "T00:00:00");
  const map = ["Minggu","Senin","Selasa","Rabu","Kamis","Jum'at","Sabtu"];
  return map[d.getDay()] || "";
};

function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(window.__t);
  window.__t = setTimeout(()=> el.style.display="none", 2400);
}
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}
function csvSafe(str){
  const s = String(str??"").replaceAll('"','""');
  return `"${s}"`;
}
function clampISO(iso){
  // basic safe: YYYY-MM-DD or fallback today
  return (/^\d{4}-\d{2}-\d{2}$/.test(String(iso||""))) ? iso : todayISO();
}

/* =========================
   APP STATE (IN MEMORY ONLY)
========================= */
const APP_STATE = {
  session: { loggedIn: false },
  drivers: [
    { id:"wawan", name:"Wawan" },
    { id:"agus",  name:"Agus" }
  ],
  orders: [],
  payments: []
};

// Default UI range: last 7 days
const DEFAULT_FROM = addDaysISO(todayISO(), -6);
const DEFAULT_TO   = todayISO();

function getDriverById(id){ return APP_STATE.drivers.find(d => d.id === id); }
function feeFromJasa(jasa){ return Math.round(Number(jasa||0) * ADMIN_FEE_RATE); }

/* =========================
   COMPUTATIONS (range-based)
========================= */
function sumFeeForRange(driver_id, from, to){
  return APP_STATE.orders
    .filter(o => o.driver_id===driver_id && o.date>=from && o.date<=to)
    .reduce((a,o)=>a + Number(o.fee||0), 0);
}
function sumJasaForRange(driver_id, from, to){
  return APP_STATE.orders
    .filter(o => o.driver_id===driver_id && o.date>=from && o.date<=to)
    .reduce((a,o)=>a + Number(o.jasa||0), 0);
}
function sumPaidVerifiedForRange(driver_id, from, to){
  return APP_STATE.payments
    .filter(pm => pm.driver_id===driver_id && pm.status==="verified"
      && pm.range_from===from && pm.range_to===to)
    .reduce((a,pm)=>a + Number(pm.amount||0), 0);
}
function lockedForRange(driver_id, from, to){
  const fee = sumFeeForRange(driver_id, from, to);
  if(fee<=0) return false;
  const paid = sumPaidVerifiedForRange(driver_id, from, to);
  const min  = Math.ceil(fee * MIN_PAY_RATE);
  return paid < min;
}

/* =========================
   CSV PARSER
========================= */
function parseCSV(text){
  const rows = [];
  let i=0, cur="", inQ=false;
  let row = [];
  while(i < text.length){
    const ch = text[i];
    const next = text[i+1];

    if(ch === '"'){
      if(inQ && next === '"'){ cur += '"'; i+=2; continue; }
      inQ = !inQ; i++; continue;
    }
    if(!inQ && ch === ','){
      row.push(cur); cur=""; i++; continue;
    }
    if(!inQ && (ch === '\n' || ch === '\r')){
      if(ch === '\r' && next === '\n') i++;
      row.push(cur); cur="";
      rows.push(row); row=[];
      i++; continue;
    }
    cur += ch; i++;
  }
  row.push(cur); rows.push(row);
  return rows.filter(r => r.some(c => String(c||"").trim() !== ""));
}

/* =========================
   AUTH
========================= */
function isLoggedIn(){ return APP_STATE.session.loggedIn === true; }
function requireAuth(){
  if(!isLoggedIn()){
    location.hash = "#/admin/login";
    return false;
  }
  return true;
}
function logout(){
  APP_STATE.session.loggedIn = false;
  toast("Logout");
  location.hash = "#/admin/login";
}

/* =========================
   ROUTER
========================= */
const app = document.getElementById("app");

function route(){
  const path = (location.hash || "#/admin/login").replace(/^#/, "");
  renderNav(path);

  if(path.startsWith("/admin/login")) return viewLogin();
  if(!requireAuth()) return;

  if(path.startsWith("/admin/orders/new")) return viewOrderNew();
  if(path.startsWith("/admin/orders")) return viewOrdersDashboard();
  if(path.startsWith("/admin/drivers")) return viewDrivers();
  if(path.startsWith("/admin/payments")) return viewPayments();
  if(path.startsWith("/admin/export")) return viewExport();

  location.hash = "#/admin/orders";
}
window.addEventListener("hashchange", route);

/* =========================
   NAV
========================= */
function navLink(label, href, active){
  return `<a class="btn ${active?'primary':''}" href="${href}">${label}</a>`;
}
function renderNav(path){
  const nav = document.getElementById("nav");
  if(path.startsWith("/admin/login")){
    nav.innerHTML = `<span class="pill soft">Route: <b class="mono">${path}</b></span>`;
    return;
  }
  const links = [
    ["Orders", "#/admin/orders"],
    ["New Order", "#/admin/orders/new"],
    ["Drivers", "#/admin/drivers"],
    ["Payments", "#/admin/payments"],
    ["Export", "#/admin/export"],
  ];
  nav.innerHTML = `
    ${links.map(([t,h]) => navLink(t,h, path.startsWith(h.replace("#","")))).join("")}
    <button class="btn danger" onclick="logout()">Logout</button>
  `;
}

/* =========================
   LOGIN
========================= */
function viewLogin(){
  const path = (location.hash||"").replace(/^#/,"");
  app.innerHTML = `
    <div class="grid">
      <div class="card">
        <h2>/admin/login</h2>
        <div class="mut">
          Login demo (tanpa storage). user: <b>${ADMIN_USER}</b> pass: <b>${ADMIN_PASS}</b><br/>
          <span class="pill warn" style="margin-top:10px">Refresh halaman = data RAM hilang (simpan pakai Export CSV)</span>
        </div>

        <label>Username</label>
        <input id="u" value="${ADMIN_USER}" />

        <label>Password</label>
        <input id="p" type="password" value="${ADMIN_PASS}" />

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" onclick="doLogin()">Login</button>
          <span class="pill soft">Route: <b class="mono">${path || "/admin/login"}</b></span>
        </div>
      </div>

      <div class="card">
        <h2>Flow kerja</h2>
        <div class="mut">
          1) Input order (New Order) → 2) Export Orders CSV → 3) Import Orders di Drivers → rekap otomatis → 4) Payments input/import → export payments CSV.
        </div>

        <div class="hr"></div>
        <div class="mut">
          • Fee admin = <b>${Math.round(ADMIN_FEE_RATE*100)}%</b> dari jasa (otomatis).<br/>
          • Min bayar = <b>${Math.round(MIN_PAY_RATE*100)}%</b> dari total fee dalam range tanggal yang dipilih.<br/>
          • Driver “TERKUNCI” jika paid verified &lt; min.
        </div>

        <div class="hr"></div>
        <span class="pill ok">Dashboard • Professional • Simple</span>
      </div>
    </div>
  `;
}
function doLogin(){
  const u = document.getElementById("u").value.trim();
  const p = document.getElementById("p").value.trim();
  if(u===ADMIN_USER && p===ADMIN_PASS){
    APP_STATE.session.loggedIn = true;
    toast("Login sukses");
    location.hash = "#/admin/orders";
  }else{
    toast("Username / password salah");
  }
}

/* =========================
   ORDERS DASHBOARD (revisi)
   - no active period
   - just date range filter
========================= */
function viewOrdersDashboard(){
  const q = new URLSearchParams(location.hash.split("?")[1] || "");
  const from = clampISO(q.get("from") || DEFAULT_FROM);
  const to   = clampISO(q.get("to")   || DEFAULT_TO);
  const fDriver = (q.get("driver") || "all");
  const fText = (q.get("q") || "").toLowerCase().trim();

  const rows = APP_STATE.orders
    .filter(o => o.date >= from && o.date <= to)
    .filter(o => fDriver==="all" ? true : o.driver_id===fDriver)
    .filter(o => !fText ? true : (String(o.detail||"").toLowerCase().includes(fText)))
    .sort((a,b)=> (a.date>b.date?1:-1));

  const totalOrders = rows.length;
  const totalJasa = rows.reduce((a,o)=>a+Number(o.jasa||0),0);
  const totalFee  = rows.reduce((a,o)=>a+Number(o.fee||0),0);
  const avgJasa = totalOrders ? Math.round(totalJasa/totalOrders) : 0;

  // Top driver by fee within filter
  const mapFee = new Map();
  rows.forEach(o=>{
    mapFee.set(o.driver_id, (mapFee.get(o.driver_id)||0) + Number(o.fee||0));
  });
  let topDriverId = "";
  let topFee = 0;
  for(const [k,v] of mapFee.entries()){
    if(v>topFee){ topFee=v; topDriverId=k; }
  }
  const topDriver = topDriverId ? getDriverById(topDriverId) : null;

  app.innerHTML = `
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <h2>/admin/orders</h2>
          <div class="mut">Dashboard ringkas untuk cek hasil input + filter. (Data RAM only)</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <a class="btn primary" href="#/admin/orders/new">+ Input Order</a>
          <a class="btn" href="#/admin/export">Export CSV</a>
          <button class="btn danger" onclick="clearAllOrders()">Clear Orders (RAM)</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <label>Dari tanggal</label>
          <input id="oFrom" type="date" value="${from}" />
        </div>
        <div>
          <label>Sampai tanggal</label>
          <input id="oTo" type="date" value="${to}" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Driver</label>
          <select id="oDriver">
            <option value="all">All drivers</option>
            ${APP_STATE.drivers.map(d=>`<option value="${d.id}" ${d.id===fDriver?"selected":""}>${d.name}</option>`).join("")}
          </select>
        </div>
        <div>
          <label>Keyword (keterangan)</label>
          <input id="oText" value="${escapeHtml(q.get("q")||"")}" placeholder="contoh: GOFAST / kurir / transfer..." />
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn primary" onclick="applyOrdersFilter()">Apply Filter</button>
        <span class="pill soft">Range: <b class="mono">${from} → ${to}</b></span>
        <span class="pill ok">Orders: <b>${totalOrders}</b></span>
        <span class="pill soft">Tip: klik nama driver di tabel untuk quick filter</span>
      </div>

      <div class="kpi">
        <div class="box">
          <div class="label">Total Orders (filter)</div>
          <div class="val">${totalOrders}</div>
          <div class="hint">Jumlah transaksi di range</div>
        </div>
        <div class="box">
          <div class="label">Total Jasa</div>
          <div class="val">${rupiah(totalJasa)}</div>
          <div class="hint">Omset jasa di range</div>
        </div>
        <div class="box">
          <div class="label">Total Fee Admin</div>
          <div class="val">${rupiah(totalFee)}</div>
          <div class="hint">Fee = 15% dari jasa</div>
        </div>
        <div class="box">
          <div class="label">Highlight</div>
          <div class="val">${topDriver ? topDriver.name : "-"}</div>
          <div class="hint">${topDriver ? `Top fee: ${rupiah(topFee)}` : `Rata-rata jasa: ${rupiah(avgJasa)}`}</div>
        </div>
      </div>

      <div class="miniGrid">
        <div>
          <div class="hr"></div>
          <h2 style="margin:0 0 8px;font-size:14px">Daftar Orders (hasil filter)</h2>
          <div class="mut">Untuk audit cepat & hapus baris jika salah input.</div>

          <div style="overflow:auto;max-height:520px;margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th style="width:120px">Tanggal</th>
                  <th style="width:90px">Hari</th>
                  <th style="width:170px">Driver</th>
                  <th>Keterangan</th>
                  <th class="right" style="width:140px">Jasa</th>
                  <th class="right" style="width:150px">Admin (15%)</th>
                  <th style="width:90px">Aksi</th>
                </tr>
              </thead>
              <tbody>
                ${rows.length? rows.map(o=>{
                  const d = getDriverById(o.driver_id);
                  return `
                    <tr>
                      <td class="mono">${o.date}</td>
                      <td>${o.day||"-"}</td>
                      <td><span class="linkish" onclick="quickFilterOrdersDriver('${o.driver_id}','${from}','${to}')">${d?d.name:o.driver_id}</span></td>
                      <td style="color:var(--mut)">${escapeHtml(o.detail||"")}</td>
                      <td class="right"><b>${rupiah(o.jasa)}</b></td>
                      <td class="right">${rupiah(o.fee)}</td>
                      <td><button class="btn small danger" onclick="deleteOrder('${o.id}','${from}','${to}','${fDriver}','${encodeURIComponent(q.get("q")||"")}')">Hapus</button></td>
                    </tr>
                  `;
                }).join("") : `<tr><td colspan="7" style="color:var(--mut)">Belum ada order di range/filter ini.</td></tr>`}
              </tbody>
            </table>
          </div>
        </div>

        <div>
          <div class="hr"></div>
          <h2 style="margin:0 0 8px;font-size:14px">Quick Actions</h2>
          <div class="mut">Akses cepat untuk alur kerja utama.</div>

          <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
            <a class="btn primary" href="#/admin/orders/new">+ Input Order (cepat)</a>
            <a class="btn" href="#/admin/export">Export CSV (Orders/Payments)</a>
            <a class="btn" href="#/admin/drivers">Drivers (Import Orders + Rekap)</a>
            <a class="btn" href="#/admin/payments">Payments (Input/Import)</a>
          </div>

          <div class="hr"></div>
          <span class="pill warn">Reminder</span>
          <div class="mut" style="margin-top:10px">
            Karena tanpa penyimpanan, pastikan sesekali export CSV untuk backup.
          </div>
        </div>
      </div>
    </div>
  `;
}

function applyOrdersFilter(){
  const from = document.getElementById("oFrom").value || DEFAULT_FROM;
  const to   = document.getElementById("oTo").value   || DEFAULT_TO;
  const driver = document.getElementById("oDriver").value;
  const qText = document.getElementById("oText").value.trim();
  if(from>to){ toast("Range tanggal salah (From > To)"); return; }
  location.hash = `#/admin/orders?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&driver=${encodeURIComponent(driver)}&q=${encodeURIComponent(qText)}`;
}
function quickFilterOrdersDriver(driverId, from, to){
  const q = new URLSearchParams(location.hash.split("?")[1] || "");
  const qText = q.get("q") || "";
  location.hash = `#/admin/orders?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&driver=${encodeURIComponent(driverId)}&q=${encodeURIComponent(qText)}`;
}
function deleteOrder(orderId, from, to, driver, qEnc){
  APP_STATE.orders = APP_STATE.orders.filter(o=>o.id!==orderId);
  toast("Order dihapus");
  // stay on same dashboard filter
  const qText = decodeURIComponent(qEnc||"");
  location.hash = `#/admin/orders?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&driver=${encodeURIComponent(driver)}&q=${encodeURIComponent(qText)}`;
}
function clearAllOrders(){
  if(!confirm("Clear semua orders di RAM?")) return;
  APP_STATE.orders = [];
  toast("Orders cleared");
  route();
}

/* =========================
   NEW ORDER (revisi)
   - date => day auto
   - stay on form after save
========================= */
function viewOrderNew(){
  // keep last used date if any (nice for fast input)
  const q = new URLSearchParams(location.hash.split("?")[1] || "");
  const presetDate = clampISO(q.get("date") || todayISO());
  const presetDay = dayNameID(presetDate);

  app.innerHTML = `
    <div class="grid">
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start">
          <div>
            <h2>/admin/orders/new</h2>
            <div class="mut">Input cepat: pilih tanggal → hari otomatis. Setelah simpan, form tetap di sini.</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <a class="btn" href="#/admin/orders">Kembali ke Dashboard</a>
            <a class="btn" href="#/admin/export">Export CSV</a>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div>
            <label>Tanggal</label>
            <input id="date" type="date" value="${presetDate}" />
          </div>
          <div>
            <label>Hari (otomatis)</label>
            <input id="day" value="${presetDay}" readonly />
          </div>
        </div>

        <label>Nama Driver</label>
        <select id="driver">
          ${APP_STATE.drivers.map(d=>`<option value="${d.id}">${d.name}</option>`).join("")}
        </select>

        <label>Detail Pesanan / Keterangan</label>
        <textarea id="detail" placeholder="contoh: GOFAST DELIVERY ORDER #... / alamat / catatan"></textarea>

        <div class="row">
          <div>
            <label>Jasa (Rp)</label>
            <input id="jasa" type="number" min="0" placeholder="contoh: 7000" />
          </div>
          <div>
            <label>Biaya Admin (${Math.round(ADMIN_FEE_RATE*100)}%)</label>
            <input id="fee" disabled placeholder="auto" />
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button class="btn primary" onclick="saveNewOrderStay()">Simpan Order</button>
          <button class="btn" onclick="resetFormNewOrder()">Reset Form</button>
          <span class="pill soft">Data: <b>RAM only</b> — backup pakai Export</span>
        </div>

        <div class="hr"></div>
        <div class="mut">
          Tips input cepat: setelah simpan, tinggal ganti driver atau jasa untuk order berikutnya.
        </div>
      </div>

      <div class="card">
        <h2>Info Pembayaran</h2>
        <div class="mut">
          Rule: driver bayar fee admin minimal <b>${Math.round(MIN_PAY_RATE*100)}%</b> dari total fee dalam range tanggal yang dipilih (di Drivers/Payments).
        </div>

        <div class="hr"></div>

        <span class="pill ok">BCA <b class="mono">1210532427</b></span>
        <span class="pill soft" style="margin-top:10px">a/n <b>Ahmad Rosidi</b></span>
        <span class="pill soft" style="margin-top:10px">QRIS</span>

        <div class="hr"></div>
        <div class="mut">
          Setelah input banyak order: buka menu <b>Export</b> → download Orders CSV.
          Lalu menu <b>Drivers</b> → import untuk rekap.
        </div>
      </div>
    </div>
  `;

  // auto day when date changed
  const dateEl = document.getElementById("date");
  const dayEl  = document.getElementById("day");
  dateEl.addEventListener("input", ()=>{
    dayEl.value = dayNameID(dateEl.value);
  });

  // auto fee when jasa typed
  const jasaEl = document.getElementById("jasa");
  const feeEl = document.getElementById("fee");
  jasaEl.addEventListener("input", ()=>{
    feeEl.value = rupiah(feeFromJasa(jasaEl.value));
  });

  // default focus
  setTimeout(()=> document.getElementById("jasa").focus(), 50);
}

function resetFormNewOrder(){
  const dateEl = document.getElementById("date");
  const dayEl = document.getElementById("day");
  const detailEl = document.getElementById("detail");
  const jasaEl = document.getElementById("jasa");
  const feeEl = document.getElementById("fee");

  // keep date & driver for speed, clear only jasa + detail by default
  detailEl.value = "";
  jasaEl.value = "";
  feeEl.value = "";
  dayEl.value = dayNameID(dateEl.value);
  jasaEl.focus();
}

function saveNewOrderStay(){
  const date = document.getElementById("date").value;
  const driver_id = document.getElementById("driver").value;
  const detail = document.getElementById("detail").value.trim();
  const jasa = Number(document.getElementById("jasa").value||0);

  if(!date){ toast("Tanggal wajib"); return; }
  if(!driver_id){ toast("Driver wajib"); return; }
  if(jasa<=0){ toast("Jasa harus > 0"); return; }

  const day = dayNameID(date);
  const fee = feeFromJasa(jasa);

  APP_STATE.orders.push({
    id: uid(),
    date, day, driver_id,
    detail,
    jasa, fee,
    created_at: nowStamp()
  });

  toast("Order tersimpan ✅ (tetap di form)");
  // stay on form & reset only fields for fast input
  resetFormNewOrder();

  // keep URL date param for convenience
  location.hash = `#/admin/orders/new?date=${encodeURIComponent(date)}`;
}

/* =========================
   DRIVERS
   - Range filter (no active period)
   - Import Orders CSV
========================= */
function viewDrivers(){
  const q = new URLSearchParams(location.hash.split("?")[1] || "");
  const from = clampISO(q.get("from") || DEFAULT_FROM);
  const to   = clampISO(q.get("to")   || DEFAULT_TO);

  const rows = APP_STATE.drivers.map(d=>{
    const fee = sumFeeForRange(d.id, from, to);
    const paid = sumPaidVerifiedForRange(d.id, from, to);
    const min = Math.ceil(fee*MIN_PAY_RATE);
    const locked = lockedForRange(d.id, from, to);
    const unpaid = Math.max(0, fee - paid);
    return {d, fee, paid, min, unpaid, locked};
  });

  app.innerHTML = `
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <h2>/admin/drivers</h2>
          <div class="mut">Rekap driver berdasarkan range tanggal yang kamu pilih. Import Orders CSV di sini.</div>
        </div>
        <button class="btn primary" onclick="addDriverPrompt()">+ Tambah Driver</button>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <label>From</label>
          <input id="dFrom" type="date" value="${from}" />
        </div>
        <div>
          <label>To</label>
          <input id="dTo" type="date" value="${to}" />
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn primary" onclick="applyDriverRange()">Apply Range</button>
        <span class="pill soft">Range: <b class="mono">${from} → ${to}</b></span>
        <span class="pill soft">Orders: <b>${APP_STATE.orders.length}</b></span>
        <span class="pill soft">Payments: <b>${APP_STATE.payments.length}</b></span>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <h2 style="margin:0 0 8px;font-size:14px">Import Orders (CSV)</h2>
          <div class="mut">Import file hasil export Orders. Setelah import, rekap driver langsung terisi.</div>
        </div>
        <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;justify-content:flex-end">
          <input id="importOrdersFile" type="file" accept=".csv" />
          <button class="btn primary" onclick="importOrdersCSV()">Import</button>
          <button class="btn danger" onclick="clearOrdersDrivers()">Clear Orders</button>
        </div>
      </div>

      <div class="hr"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="width:220px">Driver</th>
              <th>Status</th>
              <th class="right" style="width:160px">Fee (range)</th>
              <th class="right" style="width:160px">Min bayar</th>
              <th class="right" style="width:160px">Paid (verified)</th>
              <th class="right" style="width:160px">Belum bayar</th>
              <th style="width:210px">Aksi</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td><b>${r.d.name}</b><div class="mut mono">id: ${r.d.id}</div></td>
                <td>${r.locked ? `<span class="pill bad">TERKUNCI</span>` : `<span class="pill ok">AKTIF</span>`}</td>
                <td class="right">${rupiah(r.fee)}</td>
                <td class="right">${rupiah(r.min)}</td>
                <td class="right">${rupiah(r.paid)}</td>
                <td class="right"><b>${rupiah(r.unpaid)}</b></td>
                <td style="display:flex;gap:8px;flex-wrap:wrap">
                  <button class="btn small" onclick="goOrdersDriver('${r.d.id}','${from}','${to}')">Orders</button>
                  <button class="btn small primary" onclick="goPaymentsDriver('${r.d.id}','${from}','${to}')">Payments</button>
                  <button class="btn small danger" onclick="deleteDriver('${r.d.id}')">Hapus</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>

      <div class="mut" style="margin-top:10px">
        Terkunci = Fee (range) &gt; 0 dan verified &lt; ${Math.round(MIN_PAY_RATE*100)}% dari fee (range).<br/>
        <span class="pill warn" style="margin-top:10px">Tanpa penyimpanan: simpan pakai Export CSV</span>
      </div>
    </div>
  `;
}
function applyDriverRange(){
  const from = document.getElementById("dFrom").value || DEFAULT_FROM;
  const to   = document.getElementById("dTo").value   || DEFAULT_TO;
  if(from>to){ toast("Range tanggal salah (From > To)"); return; }
  location.hash = `#/admin/drivers?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;
}

function importOrdersCSV(){
  const inp = document.getElementById("importOrdersFile");
  const f = inp && inp.files ? inp.files[0] : null;
  if(!f){ toast("Pilih file Orders CSV dulu"); return; }

  const reader = new FileReader();
  reader.onload = () => {
    try{
      const text = String(reader.result||"");
      const grid = parseCSV(text);
      const header = grid[0].map(h=>String(h||"").trim());
      const idx = (name)=> header.indexOf(name);

      const need = ["date","day","driver_id","detail","jasa","fee_admin","created_at"];
      for(const k of need){
        if(idx(k) === -1){
          toast(`Header Orders CSV tidak cocok. Harus ada kolom: ${k}`);
          return;
        }
      }

      const out = [];
      for(let r=1;r<grid.length;r++){
        const row = grid[r];
        const date = (row[idx("date")]||"").trim();
        if(!date) continue;

        const driver_id = (row[idx("driver_id")]||"").trim();
        const jasa = Number((row[idx("jasa")]||"0").toString().replace(/[^\d.-]/g,"")) || 0;
        const fee = Number((row[idx("fee_admin")]||"0").toString().replace(/[^\d.-]/g,"")) || feeFromJasa(jasa);
        const day = (row[idx("day")]||"").trim() || dayNameID(date);

        out.push({
          id: uid(),
          date,
          day,
          driver_id,
          detail: (row[idx("detail")]||""),
          jasa,
          fee,
          created_at: (row[idx("created_at")]||"").trim() || nowStamp()
        });
      }

      APP_STATE.orders = out;
      toast(`Import Orders sukses: ${out.length} rows`);
      route();
    }catch(e){
      console.error(e);
      toast("Gagal import Orders CSV");
    }
  };
  reader.readAsText(f);
}
function clearOrdersDrivers(){
  if(!confirm("Clear Orders di RAM?")) return;
  APP_STATE.orders = [];
  toast("Orders cleared");
  route();
}

function addDriverPrompt(){
  const name = prompt("Nama driver?");
  if(!name) return;
  const id = prompt("ID driver (tanpa spasi, contoh: alan)?", name.toLowerCase().replace(/\s+/g,""));
  if(!id) return;

  if(APP_STATE.drivers.some(d=>d.id===id)){ toast("ID sudah ada"); return; }
  APP_STATE.drivers.push({id, name});
  toast("Driver ditambahkan");
  route();
}
function deleteDriver(driverId){
  if(!confirm("Yakin hapus driver? (orders & payments utk driver ini juga dihapus dari RAM)")) return;
  APP_STATE.drivers = APP_STATE.drivers.filter(d=>d.id!==driverId);
  APP_STATE.orders = APP_STATE.orders.filter(o=>o.driver_id!==driverId);
  APP_STATE.payments = APP_STATE.payments.filter(p=>p.driver_id!==driverId);
  toast("Driver dihapus");
  route();
}
function goOrdersDriver(driverId, from, to){
  location.hash = `#/admin/orders?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&driver=${encodeURIComponent(driverId)}&q=`;
}
function goPaymentsDriver(driverId, from, to){
  location.hash = `#/admin/payments?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&driver=${encodeURIComponent(driverId)}&status=all`;
}

/* =========================
   PAYMENTS (range-based) + Import/Export
========================= */
let modalRangeFrom = "";
let modalRangeTo = "";

function viewPayments(){
  const q = new URLSearchParams(location.hash.split("?")[1] || "");
  const from = clampISO(q.get("from") || DEFAULT_FROM);
  const to   = clampISO(q.get("to")   || DEFAULT_TO);
  const selectedDriver = q.get("driver") || "all";
  const fStatus = q.get("status") || "all";

  const rows = APP_STATE.payments
    .filter(pm => pm.range_from===from && pm.range_to===to)
    .filter(pm => selectedDriver==="all" ? true : pm.driver_id===selectedDriver)
    .filter(pm => fStatus==="all" ? true : pm.status===fStatus)
    .sort((a,b)=> (String(b.created_at).localeCompare(String(a.created_at))));

  const pendingCount = rows.filter(r=>r.status==="pending").length;
  const verifiedCount = rows.filter(r=>r.status==="verified").length;

  let summaryHtml = `
    <div class="card" style="margin-top:14px">
      <h2>Ringkasan</h2>
      <div class="mut">Pilih driver untuk lihat total fee & kewajiban bayar di range ini.</div>
    </div>
  `;

  if(selectedDriver !== "all"){
    const d = getDriverById(selectedDriver);
    const fee = sumFeeForRange(selectedDriver, from, to);
    const min = Math.ceil(fee * MIN_PAY_RATE);
    const paid = sumPaidVerifiedForRange(selectedDriver, from, to);
    const unpaid = Math.max(0, fee - paid);
    const locked = lockedForRange(selectedDriver, from, to);

    summaryHtml = `
      <div class="card" style="margin-top:14px">
        <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start">
          <div>
            <h2>Ringkasan: ${d?d.name:selectedDriver}</h2>
            <div class="mut">Range: <b class="mono">${from} → ${to}</b></div>
          </div>
          <div>
            ${locked ? `<span class="pill bad">TERKUNCI</span>` : `<span class="pill ok">AKTIF</span>`}
          </div>
        </div>

        <div class="kpi">
          <div class="box"><div class="label">Total fee admin</div><div class="val">${rupiah(fee)}</div><div class="hint">Dari Orders</div></div>
          <div class="box"><div class="label">Minimal wajib (50%)</div><div class="val">${rupiah(min)}</div><div class="hint">Rule</div></div>
          <div class="box"><div class="label">Paid (verified)</div><div class="val">${rupiah(paid)}</div><div class="hint">Verified saja</div></div>
          <div class="box"><div class="label">Sisa belum bayar</div><div class="val"><b>${rupiah(unpaid)}</b></div><div class="hint">Fee - Paid</div></div>
        </div>

        <div class="hr"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" onclick="openPaymentModal('${selectedDriver}','${from}','${to}')">+ Tambah Payment</button>
          <span class="pill soft">BCA <b class="mono">1210532427</b> • a/n Ahmad Rosidi • QRIS</span>
        </div>
      </div>
    `;
  }

  app.innerHTML = `
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <h2>/admin/payments</h2>
          <div class="mut">Pembayaran berdasarkan range tanggal. Bisa Import/Export CSV untuk lanjut besok.</div>
        </div>
        <button class="btn primary" onclick="openPaymentModal('${selectedDriver === "all" ? "" : selectedDriver}','${from}','${to}')">+ Tambah Payment</button>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <label>From</label>
          <input id="pFrom" type="date" value="${from}">
        </div>
        <div>
          <label>To</label>
          <input id="pTo" type="date" value="${to}">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Driver</label>
          <select id="pDriver">
            <option value="all" ${selectedDriver==="all"?"selected":""}>All drivers</option>
            ${APP_STATE.drivers.map(d=>`<option value="${d.id}" ${d.id===selectedDriver?"selected":""}>${d.name}</option>`).join("")}
          </select>
        </div>
        <div>
          <label>Status</label>
          <select id="pStatus">
            ${["all","pending","verified","rejected"].map(s=>`<option value="${s}" ${s===fStatus?"selected":""}>${s.toUpperCase()}</option>`).join("")}
          </select>
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn primary" onclick="applyPaymentFilter()">Apply Filter</button>
        <span class="pill soft">Range: <b class="mono">${from} → ${to}</b></span>
        <span class="pill ok">Rows: <b>${rows.length}</b></span>
        <span class="pill warn">Pending: <b>${pendingCount}</b></span>
        <span class="pill ok">Verified: <b>${verifiedCount}</b></span>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <h2 style="margin:0 0 8px;font-size:14px">Import Payments (CSV)</h2>
          <div class="mut">Import file hasil export Payments. Data langsung masuk RAM.</div>
        </div>
        <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;justify-content:flex-end">
          <input id="importPaymentsFile" type="file" accept=".csv" />
          <button class="btn primary" onclick="importPaymentsCSV()">Import</button>
          <button class="btn danger" onclick="clearPayments()">Clear Payments</button>
        </div>
      </div>

      <div class="hr"></div>

      <div style="overflow:auto;max-height:520px">
        <table>
          <thead>
            <tr>
              <th style="width:170px">Waktu</th>
              <th style="width:170px">Driver</th>
              <th style="width:120px">Metode</th>
              <th class="right" style="width:150px">Nominal</th>
              <th style="width:140px">Status</th>
              <th>Catatan</th>
              <th style="width:230px">Aksi</th>
            </tr>
          </thead>
          <tbody>
            ${rows.length ? rows.map(pm=>{
              const d = getDriverById(pm.driver_id);
              const badge = pm.status==="verified" ? "ok" : (pm.status==="pending" ? "warn" : "bad");
              return `
                <tr>
                  <td class="mono">${pm.created_at}</td>
                  <td><b>${d?d.name:pm.driver_id}</b><div class="mut mono">${pm.driver_id}</div></td>
                  <td>${pm.method||"-"}</td>
                  <td class="right"><b>${rupiah(pm.amount)}</b></td>
                  <td><span class="pill ${badge}">${pm.status.toUpperCase()}</span></td>
                  <td style="color:var(--mut)">${escapeHtml(pm.proof_note||"")}</td>
                  <td style="display:flex;gap:8px;flex-wrap:wrap">
                    <button class="btn small" onclick="setPaymentStatus('${pm.id}','pending')">Pending</button>
                    <button class="btn small primary" onclick="setPaymentStatus('${pm.id}','verified')">Verify</button>
                    <button class="btn small danger" onclick="setPaymentStatus('${pm.id}','rejected')">Reject</button>
                    <button class="btn small danger" onclick="deletePayment('${pm.id}')">Hapus</button>
                  </td>
                </tr>
              `;
            }).join("") : `<tr><td colspan="7" style="color:var(--mut)">Belum ada payment di range ini.</td></tr>`}
          </tbody>
        </table>
      </div>
    </div>

    ${summaryHtml}
  `;
}

function applyPaymentFilter(){
  const from = document.getElementById("pFrom").value || DEFAULT_FROM;
  const to   = document.getElementById("pTo").value   || DEFAULT_TO;
  const driver = document.getElementById("pDriver").value;
  const status = document.getElementById("pStatus").value;
  if(from>to){ toast("Range tanggal salah (From > To)"); return; }
  location.hash = `#/admin/payments?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&driver=${encodeURIComponent(driver)}&status=${encodeURIComponent(status)}`;
}

/* ===== Payment Modal ===== */
function openPaymentModal(driverId, from, to){
  modalRangeFrom = from;
  modalRangeTo = to;

  const driverSel = document.getElementById("pmDriver");
  driverSel.innerHTML = APP_STATE.drivers.map(d=>`<option value="${d.id}">${d.name}</option>`).join("");

  if(driverId && APP_STATE.drivers.some(d=>d.id===driverId)){
    driverSel.value = driverId;
  }

  const d = getDriverById(driverSel.value);
  document.getElementById("modalTitle").textContent = "Tambah Payment";
  document.getElementById("modalSub").innerHTML =
    `Range: <b class="mono">${modalRangeFrom} → ${modalRangeTo}</b> • Driver: <b>${d?d.name:driverSel.value}</b>`;

  document.getElementById("pmStatus").value = "pending";
  document.getElementById("pmMethod").value = "BCA";
  document.getElementById("pmAmount").value = "";
  document.getElementById("pmNote").value = "";

  renderModalSummary(driverSel.value);

  driverSel.onchange = () => {
    const d2 = getDriverById(driverSel.value);
    document.getElementById("modalSub").innerHTML =
      `Range: <b class="mono">${modalRangeFrom} → ${modalRangeTo}</b> • Driver: <b>${d2?d2.name:driverSel.value}</b>`;
    renderModalSummary(driverSel.value);
  };

  document.getElementById("modalBackdrop").style.display = "flex";
}
function closeModal(e){
  if(e && e.target && e.target.id !== "modalBackdrop") return;
  document.getElementById("modalBackdrop").style.display = "none";
}
function renderModalSummary(driver_id){
  const fee = sumFeeForRange(driver_id, modalRangeFrom, modalRangeTo);
  const min = Math.ceil(fee * MIN_PAY_RATE);
  const paid = sumPaidVerifiedForRange(driver_id, modalRangeFrom, modalRangeTo);
  const unpaid = Math.max(0, fee - paid);

  document.getElementById("sumFee").textContent = rupiah(fee);
  document.getElementById("sumMin").textContent = rupiah(min);
  document.getElementById("sumPaid").textContent = rupiah(paid);
  document.getElementById("sumUnpaid").textContent = rupiah(unpaid);
}
function prefillMin50(){
  const driver_id = document.getElementById("pmDriver").value;
  const fee = sumFeeForRange(driver_id, modalRangeFrom, modalRangeTo);
  const min = Math.ceil(fee * MIN_PAY_RATE);
  const paid = sumPaidVerifiedForRange(driver_id, modalRangeFrom, modalRangeTo);
  const need = Math.max(0, min - paid);
  document.getElementById("pmAmount").value = need || min || 0;
}
function savePaymentFromModal(){
  const driver_id = document.getElementById("pmDriver").value;
  const status = document.getElementById("pmStatus").value;
  const method = document.getElementById("pmMethod").value;
  const amount = Number(document.getElementById("pmAmount").value||0);
  const note = document.getElementById("pmNote").value.trim();

  if(!driver_id){ toast("Driver wajib"); return; }
  if(amount<=0){ toast("Nominal harus > 0"); return; }

  APP_STATE.payments.push({
    id: uid(),
    driver_id,
    amount,
    method,
    proof_note: note,
    status: ["pending","verified","rejected"].includes(status) ? status : "pending",
    created_at: nowStamp(),
    range_from: modalRangeFrom,
    range_to: modalRangeTo
  });

  toast("Payment tersimpan (RAM)");
  closeModal();
  route();
}
function setPaymentStatus(paymentId, status){
  const pm = APP_STATE.payments.find(x=>x.id===paymentId);
  if(!pm) return;
  pm.status = status;
  toast("Status updated");
  route();
}
function deletePayment(paymentId){
  APP_STATE.payments = APP_STATE.payments.filter(p=>p.id!==paymentId);
  toast("Payment dihapus");
  route();
}

function importPaymentsCSV(){
  const inp = document.getElementById("importPaymentsFile");
  const f = inp && inp.files ? inp.files[0] : null;
  if(!f){ toast("Pilih file Payments CSV dulu"); return; }

  const reader = new FileReader();
  reader.onload = () => {
    try{
      const text = String(reader.result||"");
      const grid = parseCSV(text);
      const header = grid[0].map(h=>String(h||"").trim());
      const idx = (name)=> header.indexOf(name);

      const need = ["created_at","driver_id","method","amount","status","note","range_from","range_to"];
      for(const k of need){
        if(idx(k) === -1){
          toast(`Header Payments CSV tidak cocok. Harus ada kolom: ${k}`);
          return;
        }
      }

      const out = [];
      for(let r=1;r<grid.length;r++){
        const row = grid[r];
        const driver_id  = (row[idx("driver_id")]||"").trim();
        if(!driver_id) continue;

        const amount = Number((row[idx("amount")]||"0").toString().replace(/[^\d.-]/g,"")) || 0;

        out.push({
          id: uid(),
          created_at: (row[idx("created_at")]||"").trim() || nowStamp(),
          driver_id,
          method: (row[idx("method")]||"").trim(),
          amount,
          status: ((row[idx("status")]||"pending").trim().toLowerCase()),
          proof_note: (row[idx("note")]||""),
          range_from: clampISO((row[idx("range_from")]||"").trim()),
          range_to: clampISO((row[idx("range_to")]||"").trim())
        });
      }

      APP_STATE.payments = out;
      toast(`Import Payments sukses: ${out.length} rows`);
      route();
    }catch(e){
      console.error(e);
      toast("Gagal import Payments CSV");
    }
  };
  reader.readAsText(f);
}
function clearPayments(){
  if(!confirm("Clear Payments di RAM?")) return;
  APP_STATE.payments = [];
  toast("Payments cleared");
  route();
}

/* =========================
   EXPORT (range-based)
========================= */
function downloadBlob(filename, text){
  const blob = new Blob([text], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function viewExport(){
  const q = new URLSearchParams(location.hash.split("?")[1] || "");
  const from = clampISO(q.get("from") || DEFAULT_FROM);
  const to   = clampISO(q.get("to")   || DEFAULT_TO);

  app.innerHTML = `
    <div class="grid">
      <div class="card">
        <h2>/admin/export</h2>
        <div class="mut">Export CSV untuk “menyimpan” data (tanpa storage).</div>

        <div class="row">
          <div>
            <label>Dari tanggal</label>
            <input id="exFrom" type="date" value="${from}" />
          </div>
          <div>
            <label>Sampai tanggal</label>
            <input id="exTo" type="date" value="${to}" />
          </div>
        </div>

        <label>Driver</label>
        <select id="exDriver">
          <option value="all">All drivers</option>
          ${APP_STATE.drivers.map(d=>`<option value="${d.id}">${d.name}</option>`).join("")}
        </select>

        <div class="hr"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" onclick="downloadOrdersCSV()">Download Orders CSV</button>
          <button class="btn primary" onclick="downloadPaymentsCSV()">Download Payments CSV</button>
          <button class="btn" onclick="downloadDriverSummaryCSV()">Download Driver Summary CSV</button>
        </div>

        <div class="hr"></div>
        <span class="pill warn">Catatan: CSV bisa dibuka langsung di Excel</span>
      </div>

      <div class="card">
        <h2>Maintenance</h2>
        <div class="mut">
          • Clear data RAM kapan saja.<br/>
          • Jangan lupa export CSV jika butuh lanjut besok.
        </div>

        <div class="hr"></div>

        <button class="btn danger" onclick="clearAllData()">Clear ALL (Orders + Payments)</button>

        <div class="hr"></div>

        <span class="pill soft">Orders di RAM: <b>${APP_STATE.orders.length}</b></span>
        <span class="pill soft" style="margin-top:10px">Payments di RAM: <b>${APP_STATE.payments.length}</b></span>

        <div class="hr"></div>
        <div class="mut">
          Header Orders export sesuai import Drivers.<br/>
          Header Payments export sesuai import Payments.
        </div>
      </div>
    </div>
  `;
}

function clearAllData(){
  if(!confirm("Clear ALL data di RAM? (Orders + Payments)")) return;
  APP_STATE.orders = [];
  APP_STATE.payments = [];
  toast("All data cleared");
  route();
}

function downloadOrdersCSV(){
  const from = document.getElementById("exFrom").value;
  const to = document.getElementById("exTo").value;
  const driver = document.getElementById("exDriver").value;

  const rows = APP_STATE.orders
    .filter(o => o.date>=from && o.date<=to)
    .filter(o => driver==="all" ? true : o.driver_id===driver)
    .sort((a,b)=> a.date>b.date?1:-1);

  const header = ["date","day","driver_id","driver_name","detail","jasa","fee_admin","created_at"];
  const lines = [header.join(",")];

  rows.forEach(o=>{
    const d = getDriverById(o.driver_id);
    lines.push([
      o.date,
      (o.day||""),
      o.driver_id,
      csvSafe(d?d.name:""),
      csvSafe(o.detail||""),
      o.jasa,
      o.fee,
      csvSafe(o.created_at||"")
    ].join(","));
  });

  const name = `orders_${from}_to_${to}_${driver}.csv`;
  downloadBlob(name, lines.join("\n"));
  toast("CSV orders dibuat");
}

function downloadPaymentsCSV(){
  const from = document.getElementById("exFrom").value;
  const to = document.getElementById("exTo").value;
  const driver = document.getElementById("exDriver").value;

  const rows = APP_STATE.payments
    .filter(pm => pm.range_from===from && pm.range_to===to)
    .filter(pm => driver==="all" ? true : pm.driver_id===driver)
    .sort((a,b)=> String(b.created_at).localeCompare(String(a.created_at)));

  // IMPORTANT: include range_from/range_to for import
  const header = ["created_at","driver_id","driver_name","method","amount","status","note","range_from","range_to"];
  const lines = [header.join(",")];

  rows.forEach(pm=>{
    const d = getDriverById(pm.driver_id);
    lines.push([
      csvSafe(pm.created_at||""),
      pm.driver_id,
      csvSafe(d?d.name:""),
      csvSafe(pm.method||""),
      pm.amount,
      pm.status,
      csvSafe(pm.proof_note||""),
      pm.range_from,
      pm.range_to
    ].join(","));
  });

  const name = `payments_${from}_to_${to}_${driver}.csv`;
  downloadBlob(name, lines.join("\n"));
  toast("CSV payments dibuat");
}

function downloadDriverSummaryCSV(){
  // use range from export inputs for consistency
  const from = document.getElementById("exFrom").value;
  const to = document.getElementById("exTo").value;

  const header = ["driver_id","driver_name","jasa_range","fee_range","min_required(50%)","paid_verified","unpaid","status(range)","range_from","range_to"];
  const lines = [header.join(",")];

  APP_STATE.drivers.forEach(d=>{
    const jasa = sumJasaForRange(d.id, from, to);
    const fee = sumFeeForRange(d.id, from, to);
    const min = Math.ceil(fee*MIN_PAY_RATE);
    const paid = sumPaidVerifiedForRange(d.id, from, to);
    const unpaid = Math.max(0, fee - paid);
    const status = lockedForRange(d.id, from, to) ? "LOCKED" : "ACTIVE";
    lines.push([
      d.id,
      csvSafe(d.name),
      jasa,
      fee,
      min,
      paid,
      unpaid,
      status,
      from,
      to
    ].join(","));
  });

  const name = `driver_summary_${from}_to_${to}.csv`;
  downloadBlob(name, lines.join("\n"));
  toast("CSV summary dibuat");
}

/* =========================
   BOOT
========================= */
(function boot(){
  if(!location.hash) location.hash = "#/admin/login";
  route();
})();
</script>
</body>
</html>
